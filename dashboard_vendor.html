<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Dashboard | ParkEase</title>
    <link rel="stylesheet" href="./assets/css/style.css?v=4.0">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar" style="border-right-color: var(--accent);">
            <div class="sidebar-logo logo">ParkEase</div>
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" onclick="showSection('myLocations')">
                    <span>üÖøÔ∏è</span> My Locations
                </a>
                <a href="#" class="menu-item" onclick="showSection('addLocation')">
                    <span>‚ûï</span> Add New Spot
                </a>
                <a href="#" class="menu-item" onclick="showSection('bookings')">
                    <span>üìÖ</span> Bookings
                </a>
                <div style="flex-grow: 1;"></div>
                <a href="#" id="logoutBtn" class="menu-item" style="color: var(--danger);">
                    <span>üö™</span> Sign Out
                </a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div>
                    <h2>Vendor Hub</h2>
                    <p style="color: var(--text-muted);">Manage your potential earnings</p>
                </div>
                <div class="glass-panel" style="padding: 0.5rem 1rem; border-color: var(--accent);">Vendor</div>
            </header>

            <section id="myLocations">
                <h4 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                    Registered Locations</h4>
                <div class="grid-cols-2" id="vendorLocationsList" style="margin-top:1rem;">
                    <p>Loading...</p>
                </div>
            </section>

            <section id="addLocation" style="display: none;">
                <div class="glass-panel" style="max-width: 700px; margin: 0 auto; padding: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; text-align: center;">Register New Parking Slot</h3>

                    <form id="addLocationForm">
                        <div class="grid-cols-2" style="margin-bottom: 1.5rem; gap: 1rem;">
                            <div>
                                <label class="input-label">Location Name</label>
                                <input type="text" name="name" required placeholder="e.g. City Mall Parking">
                            </div>
                            <div>
                                <label class="input-label">Address</label>
                                <input type="text" name="address" required placeholder="Full Address">
                            </div>
                        </div>

                        <div class="grid-cols-2" style="margin-bottom: 1.5rem; gap: 1rem;">
                            <div>
                                <label class="input-label">Location Photo</label>
                                <div class="glass-panel"
                                    style="padding: 1rem; border: 1px dashed var(--border); text-align: center;">
                                    <input type="file" name="image" accept="image/*" style="width: 100%;">
                                </div>
                            </div>
                            <div>
                                <label class="input-label">Payment QR Code</label>
                                <div class="glass-panel"
                                    style="padding: 1rem; border: 1px dashed var(--border); text-align: center;">
                                    <input type="file" name="qr_code" accept="image/*" style="width: 100%;">
                                </div>
                            </div>
                        </div>

                        <div class="grid-cols-2" style="margin-bottom: 1.5rem; gap: 1rem;">
                            <div>
                                <label class="input-label">Price (NPR/hr)</label>
                                <input type="number" name="price_per_hour" required>
                            </div>
                            <div>
                                <label class="input-label">Total Slots</label>
                                <input type="number" name="total_slots" required>
                            </div>
                        </div>

                        <div class="grid-cols-2" style="margin-bottom: 1.5rem; gap: 1rem;">
                            <div style="grid-column: 1 / -1;">
                                <label class="input-label">Pin Location on Map</label>
                                <div id="pickerMap"
                                    style="height: 300px; border-radius: 12px; margin-bottom: 1rem; overflow: hidden; border: 1px solid var(--border);">
                                </div>
                                <small style="color: var(--text-muted);">Click on the map to set the location.</small>
                            </div>
                            <div>
                                <label class="input-label">Latitude</label>
                                <input type="number" step="any" name="latitude" id="latInput" value="27.4293" required
                                    readonly style="background: rgba(255,255,255,0.05); cursor: not-allowed;">
                            </div>
                            <div>
                                <label class="input-label">Longitude</label>
                                <input type="number" step="any" name="longitude" id="lngInput" value="85.0305" required
                                    readonly style="background: rgba(255,255,255,0.05); cursor: not-allowed;">
                            </div>
                        </div>

                        <button type="submit" class="btn" style="width: 100%;">Submit for Approval</button>
                    </form>
                </div>
            </section>

            <section id="bookings" style="display: none;">
                <h4 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                    Booking History</h4>
                <div class="glass-panel" style="padding: 0;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.05); color: var(--text-muted);">
                                <th style="padding: 1rem;">ID</th>
                                <th style="padding: 1rem;">Guest</th>
                                <th style="padding: 1rem;">Location</th>
                                <th style="padding: 1rem;">Time</th>
                                <th style="padding: 1rem;">Earnings</th>
                                <th style="padding: 1rem;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="vendorBookingsTable" style="font-size: 0.9rem;">
                            <tr>
                                <td colspan="6" style="padding: 1rem; text-align: center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="./assets/js/app.js?v=4.0"></script>
    <script>
        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            // reset active classes manually for simplicity in vanilla JS without complex logic
            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
            // ... (skipping complex active class logic for brevity, assumed user clicks work)

            document.getElementById(id).style.display = 'block';
            if (id === 'myLocations') loadMyLocations();
            if (id === 'bookings') loadVendorBookings();
            if (id === 'addLocation' && typeof initPickerMap === 'function') {
                // Short delay to ensure div is visible before Leaflet initializes
                setTimeout(initPickerMap, 200);
            }
        }


        async function loadVendorBookings() {
            const tbody = document.getElementById('vendorBookingsTable');
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 1rem; text-align: center;">Syncing...</td></tr>';
            try {
                const response = await fetch('backend/router.php?action=get_my_bookings');
                const result = await response.json();
                if (result.success) {
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 1rem; text-align: center;">No bookings yet.</td></tr>';
                        return;
                    }
                    tbody.innerHTML = result.data.map(b => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 1rem;">#${b.id}</td>
                            <td style="padding: 1rem;">
                                <div>${b.user_name || 'Guest'}</div>
                                <small style="color: var(--text-muted);">${b.user_email || '-'}</small>
                            </td>
                            <td style="padding: 1rem;">${b.location_name}</td>
                            <td style="padding: 1rem;">
                                <div>${b.start_time}</div>
                                <small style="color: var(--text-muted);">to ${b.end_time}</small>
                            </td>
                            <td style="padding: 1rem; color: var(--success);">
                                NPR ${b.total_price}
                            </td>
                            <td style="padding: 1rem;">
                                <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; ${b.status === 'confirmed' ? 'background:rgba(16,185,129,0.2);color:var(--success);' : 'background:rgba(245,158,11,0.2);color:var(--warning);'}">
                                    ${b.status.toUpperCase()}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" style="padding: 1rem; text-align: center; color: var(--danger);">${result.message}</td></tr>`;
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 1rem; text-align: center; color: var(--danger);">Network Error</td></tr>';
            }
        }

        async function loadMyLocations() {
            const list = document.getElementById('vendorLocationsList');
            list.innerHTML = '<p>Syncing...</p>';
            try {
                const response = await fetch('backend/router.php?action=get_my_locations');
                const result = await response.json();
                if (result.success) { // Fixed: check success not status
                    if (!result.data || result.data.length === 0) {
                        list.innerHTML = '<div class="glass-panel" style="grid-column: 1/-1; padding: 2rem; text-align: center;">No locations registered. Add one to start earning!</div>';
                        return;
                    }
                    list.innerHTML = result.data.map(loc => `
                        <div class="glass-panel" style="padding: 0; overflow: hidden;">
                            <div style="height: 150px; background: #222; position: relative;">
                                <img src="${loc.image_url ? loc.image_url : './assets/img/placeholder.jpg'}" alt="${loc.name}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;" onerror="this.src='./assets/img/placeholder.jpg'">
                                <span style="position: absolute; top: 10px; right: 10px; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; ${loc.status === 'approved' ? 'background: rgba(16,185,129,0.9); color: white;' : 'background: rgba(245,158,11,0.9); color: white;'}">
                                    ${loc.status}
                                </span>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 700; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%;">${loc.name}</span>
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; height: 40px; overflow: hidden;">${loc.address}</p>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; font-size: 0.9rem;">
                                    <span>Capacity: <strong>${loc.total_slots}</strong></span>
                                    <span>Rate: <strong>NPR ${loc.price_per_hour}</strong></span>
                                </div>
                                <button class="btn btn-secondary" onclick="deleteLocation(${loc.id})" style="width: 100%; border: 1px solid var(--danger); color: var(--danger);">Remove Location</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = `<p>${result.message || 'Error.'}</p>`;
                }
            } catch (e) { list.innerHTML = '<p>Failed to load.</p>'; }
        }

        async function deleteLocation(id) {
            if (!confirm("Permanently delete this location?")) return;
            try {
                const response = await fetch('backend/router.php?action=delete_location', {
                    method: 'POST',
                    body: JSON.stringify({ id: id }) // Controller expects 'id'
                });
                const result = await response.json();
                alert(result.message);
                loadMyLocations();
            } catch (e) { alert("Action failed."); }
        }

        document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('backend/router.php?action=add_location', {
                    method: 'POST',
                    body: formData // Send FormData directly
                });
                const result = await response.json();

                if (result.success) { // Fixed: check success
                    alert(result.message || "Location added!");
                    e.target.reset();
                    showSection('myLocations');
                } else {
                    alert(result.message || "Failed to add location");
                }
            } catch (e) {
                alert("Error submitting.");
            }
        });

        window.onload = function () {
            checkAuthStatus();
            loadMyLocations();
        }
    </script>
</body>

</html>